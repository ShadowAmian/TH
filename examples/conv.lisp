(defpackage :conv
  (:use #:common-lisp
        #:mu
        #:th))

(in-package :conv)

;; some basic test on convolution
(let ((x (rnd 100 100))
      (k (rnd 10 10)))
  (prn ($size ($conv2 x k)))
  (prn ($size ($conv2 x k :full))))

(let ((x (rnd 50 100 100))
      (k (rnd 50 10 10)))
  (prn ($size ($conv2 x k)))
  (prn ($size ($conv2 x k :full))))

;; base conv2 operation
(let* ((x ($constant  '(((10 20 30 40) (41 31 21 11) (12 22 32 42) (43 33 23 13))
                        ((40 30 20 10) (11 21 31 41) (42 32 22 12) (13 23 33 43)))))
       (k ($variable '(((1 0 1) (0 1 0) (1 0 1))
                       ((1 1 1) (0 0 0) (1 1 1))))))
  (prn x)
  (prn ($conv2 ($data x) ($data k)))
  (prn ($sum ($conv2 ($data x) ($data k)) 0))
  (prn ($conv2 x k))
  (prn ($sum ($conv2 x k) 0))
  (prn ($reshape ($sum ($conv2 x k) 0) 1 2 2)))

(let* ((x ($constant  '(((10 20 30 40) (41 31 21 11) (12 22 32 42) (43 33 23 13))
                        ((40 30 20 10) (11 21 31 41) (42 32 22 12) (13 23 33 43)))))
       (k ($variable '(((1 0 1) (0 1 0) (1 0 1))
                       ((1 1 1) (0 0 0) (1 1 1)))))
       (c ($sum ($conv2 x k) 0))
       (g (tensor '((300 270) (281 311)))))
  (prn c)
  ($gs! c g)
  (prn ($gradient k)))

(let* ((x (tensor  '(((10 20 30 40) (41 31 21 11) (12 22 32 42) (43 33 23 13))
                     ((40 30 20 10) (11 21 31 41) (42 32 22 12) (13 23 33 43)))))
       (k (tensor '((((1 0 1) (0 1 0) (1 0 1))
                     ((1 1 1) (0 0 0) (1 1 1))))))
       (b (tensor '(1))))
  (prn ($conv2d x k b)))

(let* ((x (tensor  '((((10 20 30 40) (41 31 21 11) (12 22 32 42) (43 33 23 13))
                      ((40 30 20 10) (11 21 31 41) (42 32 22 12) (13 23 33 43)))
                     (((10 20 30 40) (41 31 21 11) (12 22 32 42) (43 33 23 13))
                      ((40 30 20 10) (11 21 31 41) (42 32 22 12) (13 23 33 43))))))
       (k (tensor '((((1 0 1) (0 1 0) (1 0 1))
                     ((1 1 1) (0 0 0) (1 1 1)))
                    (((1 0 1) (0 1 0) (1 0 1))
                     ((1 1 1) (0 0 0) (1 1 1))))))
       (b (tensor '(1 1))))
  (prn ($conv2d x k b)))

(let* ((x ($constant '(((10 20 30 40) (41 31 21 11) (12 22 32 42) (43 33 23 13))
                       ((40 30 20 10) (11 21 31 41) (42 32 22 12) (13 23 33 43)))))
       (k ($variable '((((1 0 1) (0 1 0) (1 0 1))
                        ((1 1 1) (0 0 0) (1 1 1))))))
       (b ($variable '(1)))
       (o ($conv2d x k b))
       (g (tensor '(((1 1) (1 1))))))
  (prn o)
  ($gs! o g)
  (prn ($reshape ($gradient k) 2 3 3))
  (prn ($gradient b))
  ($gd! (list k b) 0.01)
  (prn k)
  (prn ($reshape k 2 3 3))
  (prn b)
  (prn ($conv2d x k b)))

(let* ((x (tensor  '(((10 20 30 40 50)
                      (51 41 31 21 11)
                      (12 22 32 42 52)
                      (53 43 33 23 13)
                      (14 24 34 44 54))
                     ((10 20 30 40 50)
                      (51 41 31 21 11)
                      (12 22 32 42 52)
                      (53 43 33 23 13)
                      (14 24 34 44 54)))))
       (k (tensor '((((1 0 1) (0 1 0) (1 0 1))
                     ((1 1 1) (0 0 0) (1 1 1))))))
       (b (tensor '(1)))
       (c ($conv2d x k b))
       (p ($maxpool2d c 2 2)))
  (prn p))

(let* ((x ($constant '(((10 20 30 40 50)
                        (51 41 31 21 11)
                        (12 22 32 42 52)
                        (53 43 33 23 13)
                        (14 24 34 44 54))
                       ((10 20 30 40 50)
                        (51 41 31 21 11)
                        (12 22 32 42 52)
                        (53 43 33 23 13)
                        (14 24 34 44 54)))))
       (k ($variable '((((1 0 1) (0 1 0) (1 0 1))
                        ((1 1 1) (0 0 0) (1 1 1))))))
       (b ($variable '(1)))
       (c ($conv2d x k b))
       (p ($maxpool2d c 2 2))
       (g (tensor '(((1 1) (1 1))))))
  (prn c)
  (prn p)
  ($gs! p g)
  (prn ($gradient c))
  (prn ($gradient k)))

(let* ((x ($constant '(((10 20 30 40 50)
                        (51 41 31 21 11)
                        (12 22 32 42 52)
                        (53 43 33 23 13)
                        (14 24 34 44 54))
                       ((10 20 30 40 50)
                        (51 41 31 21 11)
                        (12 22 32 42 52)
                        (53 43 33 23 13)
                        (14 24 34 44 54)))))
       (k ($variable '((((1 0 1) (0 1 0) (1 0 1))
                        ((1 1 1) (0 0 0) (1 1 1))))))
       (b ($variable '(1)))
       (c ($conv2d x k b))
       (p ($avgpool2d c 2 2))
       (g (tensor '(((1 1) (1 1))))))
  (prn p)
  ($gs! p g)
  (prn ($gradient c))
  (prn ($gradient k)))

;; compare 2 implementations - one from th and the other from thnn
(let* ((x (tensor '((1 2 3 4)
                    (2 3 4 1)
                    (2 4 1 2)
                    (4 1 2 3))))
       (k (tensor '((1 1)
                    (1 1))))
       (c ($conv2 x k))
       (g (tensor '((1 1 1)
                    (1 1 1)
                    (1 1 1)))))
  (prn c)
  (prn ($conv2 x g))
  (prn ($xcorr2 g k :full))
  (prn ($add k ($mul ($conv2 x g) -0.01))))

(let* ((x ($variable '(((1 2 3 4)
                        (2 3 4 1)
                        (2 4 1 2)
                        (4 1 2 3)))))
       (k ($variable '((((1 1)
                         (1 1))))))
       (c ($conv2d x k))
       (g (tensor '(((1 1 1)
                     (1 1 1)
                     (1 1 1))))))
  (prn c)
  ($gs! c g)
  (prn ($gradient k))
  (prn ($gradient x))
  ($gd! (list x k) 0.01)
  (prn k))

(let* ((x ($variable '((1 2 3 4)
                       (2 3 4 1)
                       (2 4 1 2)
                       (4 1 2 3))))
       (k ($variable '((1 1)
                       (1 1))))
       (c ($conv2 x k))
       (g (tensor '((1 1 1)
                    (1 1 1)
                    (1 1 1)))))
  (prn c)
  ($gs! c g)
  (prn ($gradient k))
  (prn ($gradient x))
  ($gd! (list x k) 0.01)
  (prn k))

;; conv2, xcorr2 test - every prn should be 0.0
(let* ((x (tensor '((1 2 3 4) (2 3 4 5) (3 4 5 6) (4 5 6 7))))
       (k (tensor '((1 2 3) (4 5 6) (7 8 9))))
       (ki ($clone k))
       (ks ($storage k))
       (kis ($storage ki)))
  (loop :for i :from (1- ($count ks)) :downto 0
        :do (setf ($ kis (- ($count ks) i 1)) ($ ks i)))
  (let ((imvc ($conv2 x k))
        (imvc2 ($conv2 x k :valid))
        (imfc ($conv2 x k :full))
        (imvx ($xcorr2 x ki))
        (imvx2 ($xcorr2 x ki :valid))
        (imfx ($xcorr2 x ki :full)))
    (prn ($sum ($sub imvc imvc2)))
    (prn ($sum ($sub imvc imvx)))
    (prn ($sum ($sub imvc imvx2)))
    (prn ($sum ($sub imfc imfx)))
    (prn (- ($dot x x) ($ ($xcorr2 x x) 0 0)))
    (let ((xx (tensor 2 ($size x 0) ($size x 1)))
          (kk (tensor 2 ($size k 0) ($size k 1))))
      ($copy! ($ xx 0) x)
      ($copy! ($ xx 1) x)
      ($copy! ($ kk 0) k)
      ($copy! ($ kk 1) k)
      (let ((immvc ($conv2 xx kk))
            (immvc2 ($conv2 xx kk :valid))
            (immfc ($conv2 xx kk :full)))
        (prn ($sum ($sub ($ immvc 0) ($ immvc 1))))
        (prn ($sum ($sub ($ immvc 0) imvc)))
        (prn ($sum ($sub ($ immvc2 0) imvc2)))
        (prn ($sum ($sub ($ immfc 0) ($ immfc 1))))
        (prn ($sum ($sub ($ immfc 0) imfc)))))))

;; conv3, xcorr3 test - should be 0.0 as well
(let* ((x (tensor '(((1 2 3 4) (2 3 4 5) (3 4 5 6) (4 5 6 7))
                    ((9 8 7 6) (8 7 6 5) (7 6 5 4) (6 5 4 3)))))
       (k (tensor '(((1 2 3) (2 3 4) (3 4 5))
                    ((9 8 7) (8 7 6) (7 6 5)))))
       (ki ($clone k))
       (ks ($storage k))
       (kis ($storage ki)))
  (loop :for i :from (1- ($count ks)) :downto 0
        :do (setf ($ kis (- ($count ks) i 1)) ($ ks i)))
  (let ((imvc ($conv3 x k))
        (imvc2 ($conv3 x k :valid))
        (imfc ($conv3 x k :full))
        (imvx ($xcorr3 x ki))
        (imvx2 ($xcorr3 x ki :valid))
        (imfx ($xcorr3 x ki :full)))
    (prn ($sum ($sub imvc imvc2)))
    (prn ($sum ($sub imvc imvx)))
    (prn ($sum ($sub imvc imvx2)))
    (prn ($sum ($sub imfc imfx)))
    (prn (- ($dot x x) ($ ($xcorr3 x x) 0 0 0)))
    (let ((xx (tensor 2 ($size x 0) ($size x 1) ($size x 2)))
          (kk (tensor 2 ($size k 0) ($size k 1) ($size k 2))))
      ($copy! ($ xx 0) x)
      ($copy! ($ xx 1) x)
      ($copy! ($ kk 0) k)
      ($copy! ($ kk 1) k)
      (let ((immvc ($conv3 xx kk))
            (immvc2 ($conv3 xx kk :valid))
            (immfc ($conv3 xx kk :full)))
        (prn ($sum ($sub ($ immvc 0) ($ immvc 1))))
        (prn ($sum ($sub ($ immvc 0) imvc)))
        (prn ($sum ($sub ($ immvc2 0) imvc2)))
        (prn ($sum ($sub ($ immfc 0) ($ immfc 1))))
        (prn ($sum ($sub ($ immfc 0) imfc)))))))

;; xcorr3 and xcorr2, valid
(let* ((x (tensor '(((1 2 3 4) (2 3 4 5) (3 4 5 6) (4 5 6 7))
                    ((9 8 7 6) (8 7 6 5) (7 6 5 4) (6 5 4 3)))))
       (k (tensor '(((1 2 3) (2 3 4) (3 4 5))
                    ((9 8 7) (8 7 6) (7 6 5)))))
       (o3 ($xcorr3 x k))
       (o32 ($zero o3)))
  (loop :for i :from 0 :below ($size o3 0)
        :do (loop :for j :from 0 :below ($size k 0)
                  :do ($add! ($ o32 i) ($xcorr2 ($ x (+ i j)) ($ k j)))))
  (prn ($sum ($sub o3 o32))))

;; xcorr3 and xcorr2, full
(let* ((x (tensor '(((1 2 3 4) (2 3 4 5) (3 4 5 6) (4 5 6 7))
                    ((9 8 7 6) (8 7 6 5) (7 6 5 4) (6 5 4 3)))))
       (k (tensor '(((1 2 3) (2 3 4) (3 4 5))
                    ((9 8 7) (8 7 6) (7 6 5)))))
       (o3 ($xcorr3 x k :full))
       (o32 ($zero o3)))
  (loop :for i :from 0 :below ($size x 0)
        :do (loop :for j :from 0 :below ($size k 0)
                  :do ($add! ($ o32 (+ i j)) ($xcorr2 ($ x i) ($ k (- ($size k 0) j 1)) :full))))
  (prn ($sum ($sub o3 o32))))

;; conv3 and conv2, valid
(let* ((x (tensor '(((1 2 3 4) (2 3 4 5) (3 4 5 6) (4 5 6 7))
                    ((9 8 7 6) (8 7 6 5) (7 6 5 4) (6 5 4 3)))))
       (k (tensor '(((1 2 3) (2 3 4) (3 4 5))
                    ((9 8 7) (8 7 6) (7 6 5)))))
       (o3 ($conv3 x k))
       (o32 ($zero o3)))
  (loop :for i :from 0 :below ($size o3 0)
        :do (loop :for j :from 0 :below ($size k 0)
                  :do ($add! ($ o32 i) ($conv2 ($ x (+ i j)) ($ k (- ($size k 0) j 1))))))
  (prn ($sum ($sub o3 o32))))

;; conv3 and conv2, full
(let* ((x (tensor '(((1 2 3 4) (2 3 4 5) (3 4 5 6) (4 5 6 7))
                    ((9 8 7 6) (8 7 6 5) (7 6 5 4) (6 5 4 3)))))
       (k (tensor '(((1 2 3) (2 3 4) (3 4 5))
                    ((9 8 7) (8 7 6) (7 6 5)))))
       (o3 ($conv3 x k :full))
       (o32 ($zero o3)))
  (loop :for i :from 0 :below ($size x 0)
        :do (loop :for j :from 0 :below ($size k 0)
                  :do ($add! ($ o32 (+ i j)) ($conv2 ($ x i) ($ k j) :full))))
  (prn ($sum ($sub o3 o32))))
